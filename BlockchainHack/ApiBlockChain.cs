using System;
using System.Net.Sockets;
using System.Security.Cryptography.X509Certificates;
using System.Threading;
using System.Threading.Tasks;
using Nethereum.Hex.HexTypes;
using Nethereum.RPC.Eth.DTOs;
using Nethereum.Web3;

namespace ConsoleApplication1
{
    public class ApiBlockChain
    {
        private Web3 web3;
        private String abi;
        private String contractAdress;
        String ownerAddress = "0x3effa2d36eb2e09772f4195b89c6d11c322d626b";

        public bool unlockAccount(String senderAddress, String password)

        {
            var resultUnlock = false;
            Task.Run(async () =>
            {
                resultUnlock = await web3.Personal.UnlockAccount.SendRequestAsync(senderAddress, password, 120);
            }).GetAwaiter().GetResult();

            Console.WriteLine(resultUnlock);
            return resultUnlock;
        }

        public void inizialWeb3()
        {
            var web3temp = new Web3("http://localhost:8545");
            var password = "123";
            abi =
                @"[{""constant"":false,""inputs"":[],""name"":""createSertificationCentr"",""outputs"":[{""name"":"""",""type"":""address""}],""payable"":false,""type"":""function""},{""constant"":true,""inputs"":[{""name"":""_senderDoc"",""type"":""address""}],""name"":""getAddress"",""outputs"":[{""name"":"""",""type"":""address""}],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[{""name"":""_docHash"",""type"":""string""},{""name"":""_url"",""type"":""string""},{""name"":""_sender"",""type"":""address""},{""name"":""_recipient"",""type"":""address""}],""name"":""createSmartDeal"",""outputs"":[{""name"":"""",""type"":""address""}],""payable"":false,""type"":""function""},{""constant"":true,""inputs"":[],""name"":""sertCentrAdress"",""outputs"":[{""name"":"""",""type"":""address""}],""payable"":false,""type"":""function""},{""inputs"":[],""payable"":false,""type"":""constructor""},{""anonymous"":false,""inputs"":[{""indexed"":false,""name"":""pk_sender"",""type"":""address""},{""indexed"":false,""name"":""smartDeal"",""type"":""address""}],""name"":""LogetDealAddress"",""type"":""event""},{""anonymous"":false,""inputs"":[{""indexed"":false,""name"":""pk_sender"",""type"":""address""},{""indexed"":false,""name"":""smartDeal"",""type"":""address""}],""name"":""LogResultCreateSmartDeal"",""type"":""event""},{""anonymous"":false,""inputs"":[{""indexed"":false,""name"":"""",""type"":""address""}],""name"":""LogAddress"",""type"":""event""}]";
            var byteCode =
                "606060405234610000575b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b5b6121e58061005c6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630986bc2a1461005f578063ae22c57d146100ae578063df9d691314610121578063f8adf54a14610239575b610000565b346100005761006c610288565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576100df600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610446565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576101f7600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506105fe565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576102466109e0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561044257600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051610c2c80610a07833901808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050604051809103906000f0801561000057600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055507fb123f68b8ba02b447d91a6629e121111b7dd6061ff418a60139c8bf00522a284600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a1600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505b5b5b90565b6000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156105f8577ffb513455316e426924cccb3d245e0496a6f0996c9d5bfa48037def3069ea57d182600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019250505060405180910390a1600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690505b5b5b919050565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156109d6576000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561097257600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508073ffffffffffffffffffffffffffffffffffffffff16631e9d48cf856000604051602001526040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100005760325a03f1156100005750505060405180519050156109715785858585604051610b87806116338339018080602001806020018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200183810383528781815181526020019150805190602001908083836000831461083a575b80518252602083111561083a57602082019150602081019050602083039250610816565b505050905090810190601f1680156108665780820380516001836020036101000a031916815260200191505b508381038252868181518152602001915080519060200190808383600083146108ae575b8051825260208311156108ae5760208201915060208101905060208303925061088a565b505050905090810190601f1680156108da5780820380516001836020036101000a031916815260200191505b509650505050505050604051809103906000f0801561000057600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b5b600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1691505b5b5b50949350505050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681560060606040523461000057604051602080610c2c833981016040528080519060200190919050505b80600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b505b610bb3806100796000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631e9d48cf146100545780635dd740a31461009f578063ffdd5cf11461019b575b610000565b3461000057610085600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610349565b604051808215151515815260200191505060405180910390f35b3461000057610199600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506103e6565b005b34610000576101cc600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506107a5565b60405180806020018060200180602001848103845287818151815260200191508051906020019080838360008314610223575b805182526020831115610223576020820191506020810190506020830392506101ff565b505050905090810190601f16801561024f5780820380516001836020036101000a031916815260200191505b50848103835286818151815260200191508051906020019080838360008314610297575b80518252602083111561029757602082019150602081019050602083039250610273565b505050905090810190601f1680156102c35780820380516001836020036101000a031916815260200191505b5084810382528581815181526020019150805190602001908083836000831461030b575b80518252602083111561030b576020820191506020810190506020830392506102e7565b505050905090810190601f1680156103375780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390f35b60006000600060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020905060008160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156103db57600191506103e0565b600091505b50919050565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561079e5783600060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555082600060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001019080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061054957805160ff1916838001178555610577565b82800160010185558215610577579182015b8281111561057657825182559160200191906001019061055b565b5b50905061059c91905b80821115610598576000816000905550600101610580565b5090565b505081600060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206002019080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061062a57805160ff1916838001178555610658565b82800160010185558215610658579182015b8281111561065757825182559160200191906001019061063c565b5b50905061067d91905b80821115610679576000816000905550600101610661565b5090565b505080600060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206003019080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061070b57805160ff1916838001178555610739565b82800160010185558215610739579182015b8281111561073857825182559160200191906001019061071d565b5b50905061075e91905b8082111561075a576000816000905550600101610742565b5090565b50507fa18d048c2c086b3908876f33376b5db8d7d516c3363beac8d26ec6ff8397f46e6001604051808215151515815260200191505060405180910390a15b5b5b50505050565b6020604051908101604052806000815250602060405190810160405280600081525060206040519081016040528060008152506000600060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090507f5426eec213f09ddefa668b240203fe4d2045f5f365c035a6ebba8082b9d24a3e858260010183600201604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200180602001806020018381038352858181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156109045780601f106108d957610100808354040283529160200191610904565b820191906000526020600020905b8154815290600101906020018083116108e757829003601f168201915b50508381038252848181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156109875780601f1061095c57610100808354040283529160200191610987565b820191906000526020600020905b81548152906001019060200180831161096a57829003601f168201915b50509550505050505060405180910390a1806001018160020182600301828054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a395780601f10610a0e57610100808354040283529160200191610a39565b820191906000526020600020905b815481529060010190602001808311610a1c57829003601f168201915b50505050509250818054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ad55780601f10610aaa57610100808354040283529160200191610ad5565b820191906000526020600020905b815481529060010190602001808311610ab857829003601f168201915b50505050509150808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b715780601f10610b4657610100808354040283529160200191610b71565b820191906000526020600020905b815481529060010190602001808311610b5457829003601f168201915b505050505090509350935093505b5091939092505600a165627a7a7230582002dace4c774f2af8865a3c6ab7ed424a9d7e339be237d683c63d57804933b66600296060604052602060405190810160405280600081525060039080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061006057805160ff191683800117855561008e565b8280016001018555821561008e579182015b8281111561008d578251825591602001919060010190610072565b5b5090506100b391905b808211156100af576000816000905550600101610097565b5090565b50506000600460006101000a81548160ff0219169083151502179055503461000057604051610b87380380610b87833981016040528080518201919060200180518201919060200180519060200190919080519060200190919050505b8260039080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061015c57805160ff191683800117855561018a565b8280016001018555821561018a579182015b8281111561018957825182559160200191906001019061016e565b5b5090506101af91905b808211156101ab576000816000905550600101610193565b5090565b505080600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508360029080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061023e57805160ff191683800117855561026c565b8280016001018555821561026c579182015b8281111561026b578251825591602001919060010190610250565b5b50905061029191905b8082111561028d576000816000905550600101610275565b5090565b505081600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600560000160006101000a81548160ff0219169083151502179055506000600560000160016101000a81548160ff0219169083151502179055505b505050505b610862806103256000396000f3006060604052361561008c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680633b7104f2146100915780633d6df0d5146100b85780635600f04f1461014e57806366d003ac146101e457806367e404ce146102335780638c92556714610282578063bbbcef18146102f1578063ee53408314610323575b610000565b346100005761009e61034a565b604051808215151515815260200191505060405180910390f35b34610000576100c56103a8565b6040518080602001828103825283818151815260200191508051906020019080838360008314610114575b805182526020831115610114576020820191506020810190506020830392506100f0565b505050905090810190601f1680156101405780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761015b610446565b60405180806020018281038252838181518152602001915080519060200190808383600083146101aa575b8051825260208311156101aa57602082019150602081019050602083039250610186565b505050905090810190601f1680156101d65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576101f16104e4565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b346100005761024061050a565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576102d7600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610530565b604051808215151515815260200191505060405180910390f35b34610000576102fe6107f7565b6040518083151515158152602001821515151581526020019250505060405180910390f35b3461000057610330610823565b604051808215151515815260200191505060405180910390f35b6000600560000160009054906101000a900460ff16801561037a5750600560000160019054906101000a900460ff165b156103a0576001600460006101000a81548160ff021916908315150217905590506103a5565b600090505b90565b60028054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561043e5780601f106104135761010080835404028352916020019161043e565b820191906000526020600020905b81548152906001019060200180831161042157829003601f168201915b505050505081565b60038054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104dc5780601f106104b1576101008083540402835291602001916104dc565b820191906000526020600020905b8154815290600101906020018083116104bf57829003601f168201915b505050505081565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806105dd5750600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b156107f057826040518082805190602001908083835b6020831061061657805182526020820191506020810190506020830392506105f3565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916600260405180828054600181600116156101000203166002900480156106a45780601f106106825761010080835404028352918201916106a4565b820191906000526020600020905b815481529060010190602001808311610690575b505091505060405180910390206000191614156107a657600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610730576001600560000160006101000a81548160ff0219169083151502179055505b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156107a5576001600560000160016101000a81548160ff0219169083151502179055505b5b6107ae61034a565b90507fa7c262f5909ce4c54376dffb84139102f5a3f212942e626db0745591c490275581604051808215151515815260200191505060405180910390a18091505b5b5b50919050565b60058060000160009054906101000a900460ff16908060000160019054906101000a900460ff16905082565b600460009054906101000a900460ff16815600a165627a7a72305820f1321d1f65595f43a8d5bd05b42ba29ab1d8dab5f20356c585ea05f5407892cd0029a165627a7a7230582018320c36b3c3b2c7f99ceec344ade3c7df6938a072214bf7127df5654e0be7f20029";
            web3 = web3temp;
        }

        public string createDeal(String contractAddress, string docHash,
            string url, string senderAdress, string recipientAdress)
        {
            var contract = web3.Eth.GetContract(abi, contractAddress);
            var createSertificationCentrFunction = contract.GetFunction("createSmartDeal");

            var transactionHash = "";
            Task.Run(async () =>
            {
                transactionHash = await createSertificationCentrFunction.SendTransactionAsync(ownerAddress,
                    new HexBigInteger(900000), null,
                    docHash, url, senderAdress, recipientAdress);
            }).GetAwaiter().GetResult();
            return transactionHash;
        }

        //подписать документ
        public String signDoc(String contractAddress, String docHash,String counterpartyAdress)
        {
            var contract = web3.Eth.GetContract(abi, contractAddress);
            var createSertificationCentrFunction = contract.GetFunction("signDoc");

            var transactionHash = "";
            Task.Run(async () =>
            {
                transactionHash = await createSertificationCentrFunction.SendTransactionAsync(counterpartyAdress,
                    new HexBigInteger(900000), null,
                    docHash);
            }).GetAwaiter().GetResult();
            return transactionHash;
        }
        //подождать транзакцию

        //проверить есть ли пользователь в системе

        //проверить подписан ли обьект
        public String getStatus(String contractAddress, String docHash,String counterpartyAdress)
        {
            var contract = web3.Eth.GetContract(abi, "0x6bff537405237294a5e786fda1fa8ea315e17b58");
            
            var multiplyFunction = contract.GetFunction("getStatus");

            var result ="";
            Task.Run(async () =>
            {
                result = await multiplyFunction.CallAsync<String>();
             
            }).GetAwaiter().GetResult();
            
            Console.WriteLine( result);
            return result;
        }


        public String waitAddressAccount(String transactionHash)
        {
            TransactionReceipt receipt = null;
            while (receipt == null)
            {
                Thread.Sleep(5000);
                Task.Run(async () =>
                {
                    receipt = await web3.Eth.Transactions.GetTransactionReceipt.SendRequestAsync(transactionHash);
             
                }).GetAwaiter().GetResult();
                
            }
            return receipt.ContractAddress;
        }
    }
}